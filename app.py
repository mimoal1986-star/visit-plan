import streamlit as st
import pandas as pd
import numpy as np
import io
from datetime import datetime, date, timedelta
import calendar
import json
import base64
from typing import Dict, List, Tuple, Optional

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
st.set_page_config(
    page_title="–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ø–ª–∞–Ω–∞ –≤–∏–∑–∏—Ç–æ–≤",
    page_icon="üìä",
    layout="wide"
)

st.title("üìä –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –ø–ª–∞–Ω–∞ –≤–∏–∑–∏—Ç–æ–≤ –ø–æ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º")
st.markdown("---")

# –°–æ–∑–¥–∞–µ–º –±–æ–∫–æ–≤—É—é –ø–∞–Ω–µ–ª—å –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫
with st.sidebar:
    st.header("‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏")
    
    # –í—ã–±–æ—Ä –∫–≤–∞—Ä—Ç–∞–ª–∞ –∏ –≥–æ–¥–∞
    col1, col2 = st.columns(2)
    with col1:
        quarter = st.selectbox("–ö–≤–∞—Ä—Ç–∞–ª", [1, 2, 3, 4], index=0)
    with col2:
        year = st.selectbox("–ì–æ–¥", list(range(2023, 2027)), index=2)
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–æ–≤ –ø–æ —ç—Ç–∞–ø–∞–º
    st.subheader("–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –Ω–∞–≥—Ä—É–∑–∫–∏ –ø–æ —ç—Ç–∞–ø–∞–º")
    st.caption("–í–µ—Å—å –∫–≤–∞—Ä—Ç–∞–ª –¥–µ–ª–∏—Ç—Å—è –Ω–∞ 4 —Ä–∞–≤–Ω—ã—Ö —ç—Ç–∞–ø–∞")
    
    stage1 = st.number_input("–≠—Ç–∞–ø 1 –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç", value=0.8, min_value=0.1, max_value=2.0, step=0.1)
    stage2 = st.number_input("–≠—Ç–∞–ø 2 –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç", value=1.0, min_value=0.1, max_value=2.0, step=0.1)
    stage3 = st.number_input("–≠—Ç–∞–ø 3 –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç", value=1.2, min_value=0.1, max_value=2.0, step=0.1)
    stage4 = st.number_input("–≠—Ç–∞–ø 4 –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç", value=0.9, min_value=0.1, max_value=2.0, step=0.1)
    
    coefficients = [stage1, stage2, stage3, stage4]
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –ø–æ—Å–µ—â–µ–Ω–∏–π –Ω–∞ –Ω–µ–¥–µ–ª—é
    max_visits_per_week = st.number_input(
        "–ú–∞–∫—Å–∏–º—É–º –ø–æ—Å–µ—â–µ–Ω–∏–π –≤ –Ω–µ–¥–µ–ª—é –Ω–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞", 
        value=50, 
        min_value=1, 
        max_value=200, 
        step=1
    )
    
    st.markdown("---")
    st.info("""
    **–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:**
    1. –°–∫–∞—á–∞–π—Ç–µ —à–∞–±–ª–æ–Ω —Ñ–∞–π–ª–∞
    2. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤ –¥–≤—É—Ö –≤–∫–ª–∞–¥–∫–∞—Ö
    3. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
    4. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–†–∞—Å—Å—á–∏—Ç–∞—Ç—å"
    
    **–í–Ω–∏–º–∞–Ω–∏–µ:** –ü–ª–∞–Ω –≤–∏–∑–∏—Ç–æ–≤ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ 
    –∫–∞–∫ —Å—É–º–º–∞ –ø–æ—Å–µ—â–µ–Ω–∏–π –≤—Å–µ—Ö —Ç–æ—á–µ–∫ –ø–æ –≥–æ—Ä–æ–¥–∞–º.
    """)

# –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —à–∞–±–ª–æ–Ω–∞
def create_template():
    """–°–æ–∑–¥–∞–µ—Ç —à–∞–±–ª–æ–Ω Excel —Ñ–∞–π–ª–∞ —Å –¥–≤—É–º—è –≤–∫–ª–∞–¥–∫–∞–º–∏"""
    
    # –í–∫–ª–∞–¥–∫–∞ 1: –¢–æ—á–∫–∏ (–ø–ª–∞–Ω)
    points_data = {
        'ID_–¢–æ—á–∫–∏': ['P001', 'P002', 'P003', 'P004'],
        '–ù–∞–∑–≤–∞–Ω–∏–µ_–¢–æ—á–∫–∏': ['–ú–∞–≥–∞–∑–∏–Ω 1', '–ì–∏–ø–µ—Ä–º–∞—Ä–∫–µ—Ç 1', '–°—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç 1', '–ú–∏–Ω–∏–º–∞—Ä–∫–µ—Ç 2'],
        '–ê–¥—Ä–µ—Å': ['—É–ª. –õ–µ–Ω–∏–Ω–∞, 1', '—É–ª. –ú–∏—Ä–∞, 10', '–ø—Ä. –ü–æ–±–µ–¥—ã, 5', '—É–ª. –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è, 3'],
        '–®–∏—Ä–æ—Ç–∞': [55.7558, 55.7507, 55.7601, 55.7520],
        '–î–æ–ª–≥–æ—Ç–∞': [37.6173, 37.6177, 37.6254, 37.6200],
        '–ì–æ—Ä–æ–¥': ['–ú–æ—Å–∫–≤–∞', '–ú–æ—Å–∫–≤–∞', '–ú–æ—Å–∫–≤–∞', '–ú–æ—Å–∫–≤–∞'],
        '–¢–∏–ø': ['–ú–∏–Ω–∏', '–ì–∏–ø–µ—Ä', '–°—É–ø–µ—Ä', '–ú–∏–Ω–∏'],
        '–ö–æ–ª-–≤–æ_–ø–æ—Å–µ—â–µ–Ω–∏–π': [1, 1, 1, 2]  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 1, –µ—Å–ª–∏ –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ
    }
    
    points_df = pd.DataFrame(points_data)
    
    # –í–∫–ª–∞–¥–∫–∞ 2: –ê—É–¥–∏—Ç–æ—Ä—ã
    auditors_data = {
        'ID_–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∞': ['SOVIAUD13', 'SOVIAUD14', 'SOVIAUD15'],
        '–ì–æ—Ä–æ–¥': ['–ú–æ—Å–∫–≤–∞', '–ú–æ—Å–∫–≤–∞', '–ú–æ—Å–∫–≤–∞']
    }
    
    auditors_df = pd.DataFrame(auditors_data)
    
    # –í–∫–ª–∞–¥–∫–∞ 3: –§–∞–∫—Ç –ø–æ—Å–µ—â–µ–Ω–∏–π (–ø—É—Å—Ç–∞—è)
    visits_data = {
        'ID_–¢–æ—á–∫–∏': [],
        '–î–∞—Ç–∞_–≤–∏–∑–∏—Ç–∞': [],
        'ID_–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∞': []  # –ö—Ç–æ —Å–æ–≤–µ—Ä—à–∏–ª –≤–∏–∑–∏—Ç
    }
    
    visits_df = pd.DataFrame(visits_data)
    
    # –°–æ–∑–¥–∞–µ–º Excel —Ñ–∞–π–ª —Å —Ç—Ä–µ–º—è –≤–∫–ª–∞–¥–∫–∞–º–∏
    with pd.ExcelWriter('—à–∞–±–ª–æ–Ω_–¥–∞–Ω–Ω—ã—Ö.xlsx', engine='openpyxl') as writer:
        points_df.to_excel(writer, sheet_name='–¢–æ—á–∫–∏', index=False)
        auditors_df.to_excel(writer, sheet_name='–ê—É–¥–∏—Ç–æ—Ä—ã', index=False)
        visits_df.to_excel(writer, sheet_name='–§–∞–∫—Ç_–ø–æ—Å–µ—â–µ–Ω–∏–π', index=False)
    
    # –ß–∏—Ç–∞–µ–º —Å–æ–∑–¥–∞–Ω–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è –æ—Ç–¥–∞—á–∏
    with open('—à–∞–±–ª–æ–Ω_–¥–∞–Ω–Ω—ã—Ö.xlsx', 'rb') as f:
        excel_data = f.read()
    
    return excel_data

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤
def get_download_link(data, filename, text, mime_type='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'):
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞"""
    b64 = base64.b64encode(data).decode()
    href = f'<a href="data:{mime_type};base64,{b64}" download="{filename}">{text}</a>'
    return href

# –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
st.header("üìÑ –®–∞–±–ª–æ–Ω —Ñ–∞–π–ª–∞")

col1, col2 = st.columns(2)

with col1:
    st.subheader("–®–∞–±–ª–æ–Ω –¥–∞–Ω–Ω—ã—Ö")
    template_data = create_template()
    st.markdown(get_download_link(template_data, "—à–∞–±–ª–æ–Ω_–¥–∞–Ω–Ω—ã—Ö.xlsx", "üì• –°–∫–∞—á–∞—Ç—å —à–∞–±–ª–æ–Ω"), unsafe_allow_html=True)
    
    st.markdown("""
    **–°–æ–¥–µ—Ä–∂–∏—Ç 3 –≤–∫–ª–∞–¥–∫–∏:**
    1. **–¢–æ—á–∫–∏** - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ—Ä–≥–æ–≤—ã—Ö —Ç–æ—á–∫–∞—Ö
    2. **–ê—É–¥–∏—Ç–æ—Ä—ã** - –ø—Ä–∏–≤—è–∑–∫–∞ —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ –∫ –≥–æ—Ä–æ–¥–∞–º  
    3. **–§–∞–∫—Ç_–ø–æ—Å–µ—â–µ–Ω–∏–π** - —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ—Å–µ—â–µ–Ω–∏–µ —Ç–æ—á–µ–∫
    """)

with col2:
    st.subheader("–ü–æ–ª—è –≤ —à–∞–±–ª–æ–Ω–µ")
    st.markdown("""
    **–í–∫–ª–∞–¥–∫–∞ '–¢–æ—á–∫–∏':**
    - `ID_–¢–æ—á–∫–∏` - —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ç–æ—á–∫–∏
    - `–ù–∞–∑–≤–∞–Ω–∏–µ_–¢–æ—á–∫–∏` - –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ—Ä–≥–æ–≤–æ–π —Ç–æ—á–∫–∏
    - `–ê–¥—Ä–µ—Å` - –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ (–º–æ–∂–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º)
    - `–®–∏—Ä–æ—Ç–∞`, `–î–æ–ª–≥–æ—Ç–∞` - –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ç–æ—á–∫–∏
    - `–ì–æ—Ä–æ–¥` - –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ (–º–æ–∂–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º)
    - `–¢–∏–ø` - –ú–∏–Ω–∏/–ì–∏–ø–µ—Ä/–°—É–ø–µ—Ä
    - `–ö–æ–ª-–≤–æ_–ø–æ—Å–µ—â–µ–Ω–∏–π` - –ø–ª–∞–Ω –ø–æ—Å–µ—â–µ–Ω–∏–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 1)
    
    **–í–∫–ª–∞–¥–∫–∞ '–ê—É–¥–∏—Ç–æ—Ä—ã':**
    - `ID_–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∞` - –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
    - `–ì–æ—Ä–æ–¥` - –≥–æ—Ä–æ–¥ —Ä–∞–±–æ—Ç—ã
    
    **–í–∫–ª–∞–¥–∫–∞ '–§–∞–∫—Ç_–ø–æ—Å–µ—â–µ–Ω–∏–π':**
    - `ID_–¢–æ—á–∫–∏` - –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —Ç–æ—á–∫–∏
    - `–î–∞—Ç–∞_–≤–∏–∑–∏—Ç–∞` - –¥–∞—Ç–∞ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ—Å–µ—â–µ–Ω–∏—è
    - `ID_–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∞` - –∫—Ç–æ —Å–æ–≤–µ—Ä—à–∏–ª –≤–∏–∑–∏—Ç
    """)

st.markdown("---")

# –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞
st.header("üì§ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞")

uploaded_file = st.file_uploader("–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª —Å –¥–∞–Ω–Ω—ã–º–∏", type=['xlsx', 'xls'])

# –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö
def load_excel_file(uploaded_file):
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ Excel —Ñ–∞–π–ª–∞ —Å —Ç—Ä–µ–º—è –≤–∫–ª–∞–¥–∫–∞–º–∏"""
    try:
        # –ß–∏—Ç–∞–µ–º –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
        points_df = pd.read_excel(uploaded_file, sheet_name='–¢–æ—á–∫–∏')
        auditors_df = pd.read_excel(uploaded_file, sheet_name='–ê—É–¥–∏—Ç–æ—Ä—ã')
        visits_df = pd.read_excel(uploaded_file, sheet_name='–§–∞–∫—Ç_–ø–æ—Å–µ—â–µ–Ω–∏–π')
        
        return points_df, auditors_df, visits_df
    except Exception as e:
        st.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞: {str(e)}")
        st.error("–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª —Å–æ–¥–µ—Ä–∂–∏—Ç –≤–∫–ª–∞–¥–∫–∏: '–¢–æ—á–∫–∏', '–ê—É–¥–∏—Ç–æ—Ä—ã', '–§–∞–∫—Ç_–ø–æ—Å–µ—â–µ–Ω–∏–π'")
        return None, None, None

def process_points_data(df):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ —Ç–æ—á–µ–∫"""
    df = df.copy()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º –∫–æ–ª–æ–Ω–∫–∏
    column_mapping = {
        'ID —Ç–æ—á–∫–∏': 'ID_–¢–æ—á–∫–∏',
        '–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ—á–∫–∏': '–ù–∞–∑–≤–∞–Ω–∏–µ_–¢–æ—á–∫–∏',
        'Latitude': '–®–∏—Ä–æ—Ç–∞',
        'Longitude': '–î–æ–ª–≥–æ—Ç–∞',
        'City': '–ì–æ—Ä–æ–¥',
        'Type': '–¢–∏–ø',
        'Category': '–¢–∏–ø',
        '–ö–æ–ª-–≤–æ –ø–æ—Å–µ—â–µ–Ω–∏–π': '–ö–æ–ª-–≤–æ_–ø–æ—Å–µ—â–µ–Ω–∏–π',
        'Visits': '–ö–æ–ª-–≤–æ_–ø–æ—Å–µ—â–µ–Ω–∏–π',
        '–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å–µ—â–µ–Ω–∏–π': '–ö–æ–ª-–≤–æ_–ø–æ—Å–µ—â–µ–Ω–∏–π'
    }
    
    for old_col, new_col in column_mapping.items():
        if old_col in df.columns and new_col not in df.columns:
            df = df.rename(columns={old_col: new_col})
    
    # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Ç–∏–ø—ã —Ç–æ—á–µ–∫
    if '–¢–∏–ø' in df.columns:
        type_mapping = {
            'Convenience': '–ú–∏–Ω–∏',
            'convenience': '–ú–∏–Ω–∏',
            'Convenience Store': '–ú–∏–Ω–∏',
            'Hypermarket': '–ì–∏–ø–µ—Ä',
            'hypermarket': '–ì–∏–ø–µ—Ä',
            'Supermarket': '–°—É–ø–µ—Ä',
            'supermarket': '–°—É–ø–µ—Ä',
            '–ú–∏–Ω–∏': '–ú–∏–Ω–∏',
            '–ì–∏–ø–µ—Ä': '–ì–∏–ø–µ—Ä',
            '–°—É–ø–µ—Ä': '–°—É–ø–µ—Ä'
        }
        
        df['–¢–∏–ø'] = df['–¢–∏–ø'].map(type_mapping).fillna('–ú–∏–Ω–∏')
    
    # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å–µ—â–µ–Ω–∏–π - —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ
    if '–ö–æ–ª-–≤–æ_–ø–æ—Å–µ—â–µ–Ω–∏–π' in df.columns:
        df['–ö–æ–ª-–≤–æ_–ø–æ—Å–µ—â–µ–Ω–∏–π'] = pd.to_numeric(df['–ö–æ–ª-–≤–æ_–ø–æ—Å–µ—â–µ–Ω–∏–π'], errors='coerce').fillna(1).astype(int)
    else:
        df['–ö–æ–ª-–≤–æ_–ø–æ—Å–µ—â–µ–Ω–∏–π'] = 1  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 1 –ø–æ—Å–µ—â–µ–Ω–∏–µ
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –≤—Å–µ—Ö –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –∫–æ–ª–æ–Ω–æ–∫
    required_cols = ['ID_–¢–æ—á–∫–∏', '–ù–∞–∑–≤–∞–Ω–∏–µ_–¢–æ—á–∫–∏', '–®–∏—Ä–æ—Ç–∞', '–î–æ–ª–≥–æ—Ç–∞', '–¢–∏–ø', '–ö–æ–ª-–≤–æ_–ø–æ—Å–µ—â–µ–Ω–∏–π']
    optional_cols = ['–ê–¥—Ä–µ—Å', '–ì–æ—Ä–æ–¥']
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏
    for col in required_cols:
        if col not in df.columns:
            st.error(f"‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –∫–æ–ª–æ–Ω–∫–∞: {col}")
            return None
    
    # –î–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
    for col in optional_cols:
        if col not in df.columns:
            df[col] = ''
    
    # –£–ø–æ—Ä—è–¥–æ—á–∏–≤–∞–µ–º –∫–æ–ª–æ–Ω–∫–∏
    final_cols = required_cols + optional_cols
    df = df[final_cols]
    
    return df

def process_auditors_data(df):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∞—É–¥–∏—Ç–æ—Ä–æ–≤"""
    df = df.copy()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º –∫–æ–ª–æ–Ω–∫–∏
    column_mapping = {
        'ID –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∞': 'ID_–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∞',
        'Employee ID': 'ID_–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∞',
        'City': '–ì–æ—Ä–æ–¥'
    }
    
    for old_col, new_col in column_mapping.items():
        if old_col in df.columns and new_col not in df.columns:
            df = df.rename(columns={old_col: new_col})
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –∫–æ–ª–æ–Ω–æ–∫
    required_cols = ['ID_–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∞', '–ì–æ—Ä–æ–¥']
    
    for col in required_cols:
        if col not in df.columns:
            if col == '–ì–æ—Ä–æ–¥' and 'City' in df.columns:
                df['–ì–æ—Ä–æ–¥'] = df['City']
            else:
                st.error(f"‚ùå –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –∫–æ–ª–æ–Ω–∫–∞: {col}")
                return None
    
    return df[required_cols]

def process_visits_data(df):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö –ø–æ—Å–µ—â–µ–Ω–∏–π"""
    if df is None or df.empty:
        return pd.DataFrame(columns=['ID_–¢–æ—á–∫–∏', '–î–∞—Ç–∞_–≤–∏–∑–∏—Ç–∞', 'ID_–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∞'])
    
    df = df.copy()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º –∫–æ–ª–æ–Ω–∫–∏
    column_mapping = {
        'ID —Ç–æ—á–∫–∏': 'ID_–¢–æ—á–∫–∏',
        '–î–∞—Ç–∞ –≤–∏–∑–∏—Ç–∞': '–î–∞—Ç–∞_–≤–∏–∑–∏—Ç–∞',
        '–î–∞—Ç–∞': '–î–∞—Ç–∞_–≤–∏–∑–∏—Ç–∞',
        'Date': '–î–∞—Ç–∞_–≤–∏–∑–∏—Ç–∞',
        'ID –°–æ—Ç—Ä—É–¥–Ω–∏–∫–∞': 'ID_–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∞',
        'Employee ID': 'ID_–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∞'
    }
    
    for old_col, new_col in column_mapping.items():
        if old_col in df.columns and new_col not in df.columns:
            df = df.rename(columns={old_col: new_col})
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –∫–æ–ª–æ–Ω–æ–∫
    required_cols = ['ID_–¢–æ—á–∫–∏', '–î–∞—Ç–∞_–≤–∏–∑–∏—Ç–∞']
    optional_cols = ['ID_–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∞']
    
    for col in required_cols:
        if col not in df.columns:
            st.warning(f"‚ö†Ô∏è –í –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–µ—â–µ–Ω–∏–π –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∫–æ–ª–æ–Ω–∫–∞: {col}")
            return pd.DataFrame(columns=required_cols + optional_cols)
    
    # –î–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏, –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
    for col in optional_cols:
        if col not in df.columns:
            df[col] = ''
    
    # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞—Ç—ã
    df['–î–∞—Ç–∞_–≤–∏–∑–∏—Ç–∞'] = pd.to_datetime(df['–î–∞—Ç–∞_–≤–∏–∑–∏—Ç–∞'], errors='coerce')
    
    return df

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è ISO –Ω–æ–º–µ—Ä–∞ –Ω–µ–¥–µ–ª–∏
def get_iso_week(date_obj):
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç ISO –Ω–æ–º–µ—Ä –Ω–µ–¥–µ–ª–∏ –¥–ª—è –¥–∞—Ç—ã"""
    return date_obj.isocalendar()[1]

# –û—Å–Ω–æ–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞ —Ä–∞—Å—á–µ—Ç–∞
if st.button("üöÄ –†–∞—Å—Å—á–∏—Ç–∞—Ç—å –ø–ª–∞–Ω", type="primary", use_container_width=True):
    
    if not uploaded_file:
        st.error("‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª —Å –¥–∞–Ω–Ω—ã–º–∏!")
        st.stop()
    
    try:
        # –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–∞–π–ª–∞
        points_df_raw, auditors_df_raw, visits_df_raw = load_excel_file(uploaded_file)
        
        if points_df_raw is None:
            st.stop()
        
        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        points_df = process_points_data(points_df_raw)
        auditors_df = process_auditors_data(auditors_df_raw)
        visits_df = process_visits_data(visits_df_raw)
        
        if points_df is None or auditors_df is None:
            st.stop()
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö
        st.success("‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã!")
        
        with st.expander("üìã –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö"):
            tab1, tab2, tab3 = st.tabs(["–¢–æ—á–∫–∏", "–ê—É–¥–∏—Ç–æ—Ä—ã", "–§–∞–∫—Ç –ø–æ—Å–µ—â–µ–Ω–∏–π"])
            
            with tab1:
                st.write(f"–ó–∞–≥—Ä—É–∂–µ–Ω–æ —Ç–æ—á–µ–∫: {len(points_df)}")
                st.dataframe(points_df.head(10), use_container_width=True)
                
                # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–æ—á–∫–∞–º
                col1, col2, col3 = st.columns(3)
                with col1:
                    st.metric("–í—Å–µ–≥–æ –ø–æ—Å–µ—â–µ–Ω–∏–π (–ø–ª–∞–Ω)", points_df['–ö–æ–ª-–≤–æ_–ø–æ—Å–µ—â–µ–Ω–∏–π'].sum())
                with col2:
                    st.metric("–¢–∏–ø—ã —Ç–æ—á–µ–∫", ", ".join(points_df['–¢–∏–ø'].unique()))
                with col3:
                    cities = points_df['–ì–æ—Ä–æ–¥'].unique()
                    if len(cities) > 0 and cities[0] != '':
                        st.metric("–ì–æ—Ä–æ–¥–∞", ", ".join(cities[:3]) + ("..." if len(cities) > 3 else ""))
                    else:
                        st.metric("–ì–æ—Ä–æ–¥–∞", "–ù–µ —É–∫–∞–∑–∞–Ω—ã")
            
            with tab2:
                st.write(f"–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∞—É–¥–∏—Ç–æ—Ä–æ–≤: {len(auditors_df)}")
                st.dataframe(auditors_df.head(10), use_container_width=True)
            
            with tab3:
                if not visits_df.empty:
                    st.write(f"–ó–∞–≥—Ä—É–∂–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π –æ –ø–æ—Å–µ—â–µ–Ω–∏—è—Ö: {len(visits_df)}")
                    st.dataframe(visits_df.head(10), use_container_width=True)
                else:
                    st.info("–î–∞–Ω–Ω—ã–µ –æ –ø–æ—Å–µ—â–µ–Ω–∏—è—Ö –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç")
        
        # –ó–¥–µ—Å—å –±—É–¥–µ—Ç –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Ä–∞—Å—á–µ—Ç–∞...
        st.info("–†–∞—Å—á–µ—Ç –±—É–¥–µ—Ç –ø—Ä–æ–¥–æ–ª–∂–µ–Ω –≤ —Å–ª–µ–¥—É—é—â–µ–π —á–∞—Å—Ç–∏ –∫–æ–¥–∞...")
        
    except Exception as e:
        st.error(f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –¥–∞–Ω–Ω—ã—Ö: {str(e)}")
        import traceback
        st.error(f"–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏:\n{traceback.format_exc()}")

# –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤ –ø–æ–¥–≤–∞–ª–µ
st.markdown("---")
st.caption("""
**–ü—Ä–∏–º–µ—á–∞–Ω–∏—è:**
1. –î–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è —Ä–∞—Å—á–µ—Ç–æ–≤ –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –∏ –Ω–∞–∂–º–∏—Ç–µ "–†–∞—Å—Å—á–∏—Ç–∞—Ç—å"
2. –í —Å–ª–µ–¥—É—é—â–µ–π —á–∞—Å—Ç–∏ –∫–æ–¥–∞ –±—É–¥—É—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã: —Ä–∞—Å—á–µ—Ç –ø–ª–∞–Ω–∞, –ø–æ–ª–∏–≥–æ–Ω—ã, KML –≤—ã–≥—Ä—É–∑–∫–∞
3. –î–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≥–æ—Ä–æ–¥–∞/–∞–¥—Ä–µ—Å–∞ –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≥–µ–æ–∫–æ–¥–µ—Ä
""")